<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Barcode Detector</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #000;
    }
    #video {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }
    #target-box {
      position: absolute;
      border: 3px solid red;
      border-radius: 8px;
      display: none;
      pointer-events: none;
      z-index: 10;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 16px;
      z-index: 20;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="target-box"></div>
  <div id="status">Tap on barcode area</div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const targetBox = document.getElementById('target-box');
    const statusText = document.getElementById('status');

    let stream = null;
    let lastTapTime = 0;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = stream;
      } catch (err) {
        alert("Camera access denied or unavailable.");
        console.error(err);
      }
    }

    function handleTap(event) {
      if (!stream) return;

      const now = Date.now();
      if (now - lastTapTime < 300) return;
      lastTapTime = now;

      const rect = video.getBoundingClientRect();
      const x = ((event.clientX || event.pageX) - rect.left) / rect.width * video.videoWidth;
      const y = ((event.clientY || event.pageY) - rect.top) / rect.height * video.videoHeight;

      statusText.textContent = "Detecting barcode...";
      setTimeout(() => detectBarcodeAtPoint(x, y), 100);
    }

    function detectBarcodeAtPoint(x, y) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const { data, width, height } = imageData;

      const toGray = (i) => 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
      const gray = new Uint8ClampedArray(width * height);
      for (let i = 0, j = 0; i < data.length; i += 4, j++) {
        gray[j] = toGray(i);
      }

      const g = (x, y) => gray[Math.floor(y) * width + Math.floor(x)];

      const scanLineEdges = (cx, cy, axis, maxDist = 50) => {
        let start = axis === 'x' ? cx : cy;
        let min = start;
        let max = start;
        const threshold = 40;
        for (let d = 1; d < maxDist; d++) {
          const pos1 = axis === 'x' ? [cx - d, cy] : [cx, cy - d];
          const pos2 = axis === 'x' ? [cx + d, cy] : [cx, cy + d];
          const i1 = g(...pos1);
          const i2 = g(...pos2);
          if (Math.abs(g(cx, cy) - i1) > threshold) min = axis === 'x' ? pos1[0] : pos1[1];
          if (Math.abs(g(cx, cy) - i2) > threshold) max = axis === 'x' ? pos2[0] : pos2[1];
        }
        return [min, max];
      };

      const sampleYs = [-10, 0, 10];
      let minX = x, maxX = x;
      for (const offset of sampleYs) {
        const [l, r] = scanLineEdges(x, y + offset, 'x');
        minX = Math.min(minX, l);
        maxX = Math.max(maxX, r);
      }

      const sampleXs = [-10, 0, 10];
      let minY = y, maxY = y;
      for (const offset of sampleXs) {
        const [t, b] = scanLineEdges(x + offset, y, 'y');
        minY = Math.min(minY, t);
        maxY = Math.max(maxY, b);
      }

      minX = Math.max(0, minX); maxX = Math.min(width, maxX);
      minY = Math.max(0, minY); maxY = Math.min(height, maxY);

      const scaleX = video.offsetWidth / video.videoWidth;
      const scaleY = video.offsetHeight / video.videoHeight;

      targetBox.style.display = 'block';
      targetBox.style.left = `${minX * scaleX + video.offsetLeft}px`;
      targetBox.style.top = `${minY * scaleY + video.offsetTop}px`;
      targetBox.style.width = `${(maxX - minX) * scaleX}px`;
      targetBox.style.height = `${(maxY - minY) * scaleY}px`;

      statusText.textContent = `Detected area: ${Math.round(minX)},${Math.round(minY)} to ${Math.round(maxX)},${Math.round(maxY)}`;
    }

    video.addEventListener('click', handleTap);
    video.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        handleTap(e.touches[0]);
      }
    });

    startCamera();
  </script>
</body>
</html>
