<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Detect and Crop Barcode Rectangle</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 20px; }
    #video { width: 100%; max-width: 480px; }
    #overlay {
      position: absolute;
      border: 2px solid red;
      pointer-events: none;
    }
    #wrapper {
      position: relative;
      display: inline-block;
    }
    canvas { margin-top: 10px; border: 2px solid #333; }
  </style>
</head>
<body>
  <h2>Tap to Crop and Show Barcode Area</h2>
  <div id="wrapper">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" hidden></canvas>
    <div id="overlay"></div>
  </div>
  <canvas id="croppedCanvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.2.9/dist/quagga.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const croppedCanvas = document.getElementById('croppedCanvas');
    const overlay = document.getElementById('overlay');

    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
    }

    function drawCropBox(box) {
      const scaleX = video.offsetWidth / video.videoWidth;
      const scaleY = video.offsetHeight / video.videoHeight;
      overlay.style.left = `${box.x * scaleX}px`;
      overlay.style.top = `${box.y * scaleY}px`;
      overlay.style.width = `${box.width * scaleX}px`;
      overlay.style.height = `${box.height * scaleY}px`;
    }

    function cropImage(box) {
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const croppedCtx = croppedCanvas.getContext('2d');
      croppedCanvas.width = box.width;
      croppedCanvas.height = box.height;
      croppedCtx.drawImage(canvas, box.x, box.y, box.width, box.height, 0, 0, box.width, box.height);
    }

    document.getElementById('wrapper').addEventListener('click', () => {
      const canvasCtx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);

      Quagga.decodeSingle({
        src: imageData,
        inputStream: {
          size: 800,
        },
        locator: {
          patchSize: "medium",
          halfSample: true
        },
        numOfWorkers: 0,
        locate: true,
        decoder: {
          readers: ["code_128_reader"] // any reader, we're ignoring result
        },
      }, function (result) {
        if (result && result.box) {
          const points = result.box;
          const xs = points.map(p => p[0]);
          const ys = points.map(p => p[1]);
          const x = Math.min(...xs);
          const y =
