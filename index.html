<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tap to Crop Barcode-like Region</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video, canvas { max-width: 100%; border: 1px solid #ccc; }
    #cropped { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Tap to Detect and Crop Barcode-like Region</h2>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="overlay" style="position:absolute; top:0; left:0;"></canvas>
  <div>
    <h3>Cropped Area</h3>
    <canvas id="cropped"></canvas>
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const croppedCanvas = document.getElementById('cropped');
    const ctxOverlay = overlay.getContext('2d');
    const maxGap = 4; // max pixels between lines
    const brightnessThreshold = 100;

    // Start video stream
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
    });

    video.addEventListener('loadedmetadata', () => {
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
      overlay.style.width = video.offsetWidth + 'px';
      overlay.style.height = video.offsetHeight + 'px';
    });

    overlay.addEventListener('click', async e => {
      const rect = overlay.getBoundingClientRect();
      const scaleX = video.videoWidth / rect.width;
      const scaleY = video.videoHeight / rect.height;
      const x = Math.floor((e.clientX - rect.left) * scaleX);
      const y = Math.floor((e.clientY - rect.top) * scaleY);

      // Capture frame
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(video, 0, 0);
      const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const data = imageData.data;

      function getBrightness(x, y) {
        const i = (y * tempCanvas.width + x) * 4;
        const r = data[i], g = data[i + 1], b = data[i + 2];
        return 0.299 * r + 0.587 * g + 0.114 * b;
      }

      function isDark(x, y) {
        return getBrightness(x, y) < brightnessThreshold;
      }

      // Find the first vertical line at (x,y)
      function isVerticalLine(x) {
        let darkCount = 0;
        for (let i = 0; i < tempCanvas.height; i++) {
          if (isDark(x, i)) darkCount++;
        }
        return darkCount > tempCanvas.height * 0.4;
      }

      let startX = x, endX = x;

      while (startX > 0 && isVerticalLine(startX - 1)) startX--;
      while (endX < tempCanvas.width - 1 && isVerticalLine(endX + 1)) endX++;

      // If there are large gaps, skip
      if (endX - startX < 5) {
        alert('No barcode-like region found.');
        return;
      }

      // Find top and bottom of vertical lines
      let topY = tempCanvas.height, bottomY = 0;
      for (let cx = startX; cx <= endX; cx++) {
        for (let cy = 0; cy < tempCanvas.height; cy++) {
          if (isDark(cx, cy)) {
            if (cy < topY) topY = cy;
            if (cy > bottomY) bottomY = cy;
          }
        }
      }

      // Draw overlay rectangle
      ctxOverlay.clearRect(0, 0, overlay.width, overlay.height);
      ctxOverlay.strokeStyle = "lime";
      ctxOverlay.lineWidth = 2;
      ctxOverlay.strokeRect(startX, topY, endX - startX, bottomY - topY);

      // Crop and draw result
      const cropWidth = endX - startX;
      const cropHeight = bottomY - topY;
      if (cropWidth > 0 && cropHeight > 0) {
        const croppedCtx = croppedCanvas.getContext('2d');
        croppedCanvas.width = cropWidth;
        croppedCanvas.height = cropHeight;
        croppedCtx.putImageData(tempCtx.getImageData(startX, topY, cropWidth, cropHeight), 0, 0);
      }
    });
  </script>
</body>
</html>
