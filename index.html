<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Barcode Detector with Flashlight and Capture</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
    video, canvas { max-width: 100%; display: block; margin: auto; }
    #container { position: relative; display: inline-block; }
    #overlay, #lineCanvas {
      position: absolute;
      top: 0; left: 0;
      pointer-events: none;
    }
    #cropped { margin-top: 10px; border: 1px solid #ccc; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h2>Barcode Detection</h2>
  <div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    <canvas id="lineCanvas"></canvas>
  </div>
  <div>
    <button id="captureBtn">Capture Barcode</button>
    <button id="flashBtn">Toggle Flashlight</button>
  </div>
  <div>
    <h3>Cropped Area</h3>
    <canvas id="cropped"></canvas>
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const lineCanvas = document.getElementById('lineCanvas');
    const croppedCanvas = document.getElementById('cropped');
    const ctxOverlay = overlay.getContext('2d');
    const ctxLine = lineCanvas.getContext('2d');
    const flashBtn = document.getElementById('flashBtn');
    const captureBtn = document.getElementById('captureBtn');

    let guideY = 0;
    let track;
    let torchOn = false;

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } }
        });
        video.srcObject = stream;
        track = stream.getVideoTracks()[0];
      } catch {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        track = stream.getVideoTracks()[0];
      }
    }

    initCamera();

    video.addEventListener('loadedmetadata', () => {
      const width = video.videoWidth;
      const height = video.videoHeight;

      [overlay, lineCanvas].forEach(canvas => {
        canvas.width = width;
        canvas.height = height;
        canvas.style.width = video.offsetWidth + 'px';
        canvas.style.height = video.offsetHeight + 'px';
      });

      guideY = Math.floor(height / 2);
      drawGuideLine();
    });

    function drawGuideLine() {
      ctxLine.clearRect(0, 0, lineCanvas.width, lineCanvas.height);
      ctxLine.strokeStyle = 'red';
      ctxLine.lineWidth = 2;
      ctxLine.beginPath();
      ctxLine.moveTo(0, guideY);
      ctxLine.lineTo(lineCanvas.width, guideY);
      ctxLine.stroke();
    }

    function brightness(data, x, y, w) {
      const i = (y * w + x) * 4;
      const r = data[i], g = data[i + 1], b = data[i + 2];
      return 0.299 * r + 0.587 * g + 0.114 * b;
    }

    function isDark(data, x, y, w) {
      return brightness(data, x, y, w) < 120;
    }

    captureBtn.addEventListener('click', () => {
      const width = video.videoWidth;
      const height = video.videoHeight;
      const y = guideY;

      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = width;
      tempCanvas.height = height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(video, 0, 0);
      const imageData = tempCtx.getImageData(0, 0, width, height);
      const data = imageData.data;

      const centerX = Math.floor(width / 2);

      let maxGap = 5, gap = 0;
      let left = centerX, right = centerX;

      while (left > 1 && gap < maxGap) {
        if (isDark(data, left, y, width)) gap = 0;
        else gap++;
        left--;
      }

      gap = 0;
      while (right < width - 2 && gap < maxGap) {
        if (isDark(data, right, y, width)) gap = 0;
        else gap++;
        right++;
      }

      // Height bounds
      let topY = height, bottomY = 0;
      for (let x = left; x <= right; x++) {
        for (let cy = 0; cy < height; cy++) {
          if (isDark(data, x, cy, width)) {
            if (cy < topY) topY = cy;
            if (cy > bottomY) bottomY = cy;
          }
        }
      }

      if (bottomY - topY < 10) {
        topY = y - 50;
        bottomY = y + 50;
      }

      const w = right - left;
      const h = bottomY - topY;

      ctxOverlay.clearRect(0, 0, width, height);
      ctxOverlay.strokeStyle = "lime";
      ctxOverlay.lineWidth = 2;
      ctxOverlay.strokeRect(left, topY, w, h);

      if (w > 0 && h > 0) {
        const croppedCtx = croppedCanvas.getContext('2d');
        croppedCanvas.width = w;
        croppedCanvas.height = h;
        const croppedData = tempCtx.getImageData(left, topY, w, h);
        croppedCtx.putImageData(croppedData, 0, 0);
      }
    });

    flashBtn.addEventListener('click', async () => {
      if (!track) return alert("No video track found.");
      const capabilities = track.getCapabilities();
      if (!capabilities.torch) return alert("Torch not supported on this device.");

      try {
        await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
        torchOn = !torchOn;
        flashBtn.textContent = torchOn ? "Turn Flash Off" : "Turn Flash On";
      } catch (err) {
        console.error("Flash toggle error:", err);
        alert("Failed to toggle flashlight.");
      }
    });
  </script>
</body>
</html>
