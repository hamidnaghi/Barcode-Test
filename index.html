<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Always Crop on Tap</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
    video, canvas { max-width: 100%; display: block; margin: auto; }
    #container { position: relative; display: inline-block; }
    #overlay, #lineCanvas {
      position: absolute;
      top: 0; left: 0;
      pointer-events: none;
    }
    #cropped { margin-top: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>Tap on Barcode Area (Always Crops)</h2>
  <div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    <canvas id="lineCanvas"></canvas>
  </div>
  <div>
    <h3>Cropped Area</h3>
    <canvas id="cropped"></canvas>
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const lineCanvas = document.getElementById('lineCanvas');
    const croppedCanvas = document.getElementById('cropped');
    const ctxOverlay = overlay.getContext('2d');
    const ctxLine = lineCanvas.getContext('2d');

    let guideY = 0;

    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }
    }).then(stream => {
      video.srcObject = stream;
    }).catch(() => {
      alert("Back camera not found. Using default.");
      return navigator.mediaDevices.getUserMedia({ video: true });
    }).then(stream => {
      if (stream) video.srcObject = stream;
    });

    video.addEventListener('loadedmetadata', () => {
      const width = video.videoWidth;
      const height = video.videoHeight;

      overlay.width = width;
      overlay.height = height;
      overlay.style.width = video.offsetWidth + 'px';
      overlay.style.height = video.offsetHeight + 'px';

      lineCanvas.width = width;
      lineCanvas.height = height;
      lineCanvas.style.width = video.offsetWidth + 'px';
      lineCanvas.style.height = video.offsetHeight + 'px';

      guideY = Math.floor(height / 2);
      drawGuideLine();
    });

    function drawGuideLine() {
      ctxLine.clearRect(0, 0, lineCanvas.width, lineCanvas.height);
      ctxLine.strokeStyle = 'red';
      ctxLine.lineWidth = 2;
      ctxLine.beginPath();
      ctxLine.moveTo(0, guideY);
      ctxLine.lineTo(lineCanvas.width, guideY);
      ctxLine.stroke();
    }

    overlay.addEventListener('click', async (e) => {
      const rect = overlay.getBoundingClientRect();
      const scaleX = video.videoWidth / rect.width;
      const scaleY = video.videoHeight / rect.height;
      const clickX = Math.floor((e.clientX - rect.left) * scaleX);
      const y = guideY;

      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(video, 0, 0);
      const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const data = imageData.data;

      const brightness = (x, y) => {
        const i = (y * tempCanvas.width + x) * 4;
        const r = data[i], g = data[i + 1], b = data[i + 2];
        return 0.299 * r + 0.587 * g + 0.114 * b;
      };

      const isDark = (x, y) => brightness(x, y) < 120;

      // Trace left and right
      let maxGap = 5, gap = 0;
      let left = clickX, right = clickX;
      while (left > 1 && gap < maxGap) {
        if (isDark(left, y)) {
          gap = 0;
        } else {
          gap++;
        }
        left--;
      }

      gap = 0;
      while (right < tempCanvas.width - 2 && gap < maxGap) {
        if (isDark(right, y)) {
          gap = 0;
        } else {
          gap++;
        }
        right++;
      }

      // Height bounds
      let topY = tempCanvas.height, bottomY = 0;
      for (let x = left; x <= right; x++) {
        for (let cy = 0; cy < tempCanvas.height; cy++) {
          if (isDark(x, cy)) {
            if (cy < topY) topY = cy;
            if (cy > bottomY) bottomY = cy;
          }
        }
      }

      // Fallback if height too small
      if (bottomY - topY < 10) {
        topY = y - 50;
        bottomY = y + 50;
      }

      const w = right - left;
      const h = bottomY - topY;
      ctxOverlay.clearRect(0, 0, overlay.width, overlay.height);
      ctxOverlay.strokeStyle = "lime";
      ctxOverlay.lineWidth = 2;
      ctxOverlay.strokeRect(left, topY, w, h);

      // Crop and show
      if (w > 0 && h > 0) {
        const croppedCtx = croppedCanvas.getContext('2d');
        croppedCanvas.width = w;
        croppedCanvas.height = h;
        const croppedData = tempCtx.getImageData(left, topY, w, h);
        croppedCtx.putImageData(croppedData, 0, 0);
      }
    });
  </script>
</body>
</html>
