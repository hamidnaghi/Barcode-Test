<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Detect and Crop Rectangle</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    #video, #canvas, #croppedCanvas {
      max-width: 90vw;
      margin-top: 10px;
      border: 2px solid #000;
    }
  </style>
</head>
<body>
  <h2>Tap to Detect & Crop Rectangle</h2>
  <video id="video" autoplay playsinline></video>
  <br>
  <canvas id="canvas" hidden></canvas>
  <canvas id="croppedCanvas"></canvas>

  <!-- Load OpenCV locally -->
  <script src="opencv.js"></script> <!-- Must be placed alongside index.html -->
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const croppedCanvas = document.getElementById('croppedCanvas');

    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
    }

    function detectLargestRect(srcMat) {
      let gray = new cv.Mat();
      let blurred = new cv.Mat();
      let edged = new cv.Mat();
      let contours = new cv.MatVector();
      let hierarchy = new cv.Mat();

      cv.cvtColor(srcMat, gray, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
      cv.Canny(blurred, edged, 75, 200);

      cv.findContours(edged, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      let maxArea = 0;
      let bestRect = null;

      for (let i = 0; i < contours.size(); i++) {
        const contour = contours.get(i);
        const approx = new cv.Mat();
        cv.approxPolyDP(contour, approx, 0.02 * cv.arcLength(contour, true), true);
        if (approx.rows === 4) {
          const rect = cv.boundingRect(approx);
          const area = rect.width * rect.height;
          if (area > maxArea) {
            maxArea = area;
            bestRect = rect;
          }
        }
        approx.delete();
      }

      gray.delete(); blurred.delete(); edged.delete(); contours.delete(); hierarchy.delete();
      return bestRect;
    }

    function cropFromVideo() {
      const width = video.videoWidth;
      const height = video.videoHeight;

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, width, height);

      let src = cv.imread(canvas);
      const rect = detectLargestRect(src);

      if (rect) {
        const cropped = src.roi(rect);
        cv.imshow(croppedCanvas, cropped);
        cropped.delete();
      } else {
        alert('No rectangle found');
      }
      src.delete();
    }

    document.addEventListener('DOMContentLoaded', () => {
      startCamera();
      video.addEventListener('click', cropFromVideo);
    });
  </script>
</body>
</html>
