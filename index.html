<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barcode Detection</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }
    canvas, video {
      width: 90%;
      max-width: 400px;
      margin-top: 10px;
    }
    .buttons {
      margin: 10px;
    }
    .buttons button {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
    }
    #croppedArea img {
      max-width: 90%;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Barcode Detection</h2>
  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
  <div class="buttons">
    <button onclick="captureBarcode()">Capture Barcode</button>
    <button onclick="toggleFlashlight()">Toggle Flashlight</button>
  </div>
  <h3>Cropped Area</h3>
  <div id="croppedArea"></div>
  <script>
    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const overlayCtx = overlay.getContext("2d");
    let stream;
    let useTorch = false;

    async function initCamera() {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { exact: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 },
          advanced: [{ torch: useTorch }]
        },
        audio: false
      });
      video.srcObject = stream;

      video.onloadedmetadata = () => {
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
        drawGuides();
      };
    }

    function drawGuides() {
      overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
      overlayCtx.strokeStyle = "green";
      overlayCtx.lineWidth = 2;
      const centerX = overlay.width / 2;
      const centerY = overlay.height / 2;
      overlayCtx.beginPath();
      overlayCtx.moveTo(centerX - 20, centerY);
      overlayCtx.lineTo(centerX + 20, centerY);
      overlayCtx.stroke();
      overlayCtx.beginPath();
      overlayCtx.moveTo(centerX, 0);
      overlayCtx.lineTo(centerX, overlay.height);
      overlayCtx.stroke();
    }

    async function toggleFlashlight() {
      if (!stream) return;
      const track = stream.getVideoTracks()[0];
      const capabilities = track.getCapabilities();
      if (capabilities.torch) {
        useTorch = !useTorch;
        await track.applyConstraints({
          advanced: [{ torch: useTorch }]
        });
      }
    }

    function captureBarcode() {
      const tempCanvas = document.createElement("canvas");
      const tempCtx = tempCanvas.getContext("2d");
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      tempCtx.drawImage(video, 0, 0);

      const centerX = tempCanvas.width / 2;
      const centerY = tempCanvas.height / 2;

      const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const { data, width, height } = imageData;

      const grayscale = new Uint8ClampedArray(width * height);
      for (let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        grayscale[i / 4] = avg;
      }

      // Vertical line scan from center
      const scanX = Math.floor(centerX);
      const threshold = 30;
      const maxBarWidth = 10;
      let lines = [];

      for (let x = scanX - 150; x < scanX + 150; x++) {
        let columnDiff = 0;
        for (let y = centerY - 50; y < centerY + 50; y++) {
          const i1 = (y * width + x);
          const i2 = (y * width + x + 1);
          columnDiff += Math.abs(grayscale[i1] - grayscale[i2]);
        }
        if (columnDiff > threshold * 100) {
          lines.push(x);
        }
      }

      if (lines.length < 2) return alert("No barcode detected.");

      const firstX = lines[0];
      const lastX = lines[lines.length - 1];
      const cropWidth = lastX - firstX;
      const cropHeight = 100;
      const cropY = Math.floor(centerY - cropHeight / 2);

      const cropCanvas = document.createElement("canvas");
      cropCanvas.width = cropWidth;
      cropCanvas.height = cropHeight;
      const cropCtx = cropCanvas.getContext("2d");
      cropCtx.drawImage(video, firstX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

      const croppedImage = new Image();
      croppedImage.src = cropCanvas.toDataURL();
      const displayArea = document.getElementById("croppedArea");
      displayArea.innerHTML = "";
      displayArea.appendChild(croppedImage);
    }

    initCamera();
  </script>
</body>
</html>
