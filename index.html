<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reliable Barcode Scanner Ver 1.000 </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            touch-action: manipulation;
        }
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            height: 40vh;
            overflow: hidden;
            border: 2px solid #333;
            background: #000;
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        #alignment-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #00FF00;
            pointer-events: none;
            display: none;
            top: 50%;
            transform: translateY(-50%);
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 20px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #flashButton {
            background: #f4b142;
        }
        #flashButton.flash-on {
            background: #f44242;
        }
        #status {
            margin: 10px 0;
            color: #666;
            min-height: 20px;
            text-align: center;
        }
        #camera-error {
            color: red;
            text-align: center;
            margin: 10px 0;
            display: none;
        }
        #results {
            text-align: center;
            margin-top: 15px;
        }
        #croppedResult {
            max-width: 100%;
            border: 2px solid #4CAF50;
            display: none;
        }
        #decodedResult {
            margin-top: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <h2 style="text-align:center;">Reliable Barcode Scanner</h2>
    <p id="status">Click Start Camera to begin</p>
    <div id="camera-error"></div>

    <div id="scanner-container">
        <video id="video" playsinline autoplay muted></video>
        <div id="alignment-line"></div>
    </div>

    <div class="controls">
        <button id="startButton">Start Camera</button>
        <button id="flashButton" disabled>Turn On Flash</button>
        <button id="captureButton" disabled>Capture & Decode</button>
    </div>

    <div id="results">
        <img id="croppedResult">
        <div id="decodedResult"></div>
    </div>

    <script>
        // Elements
        const video = document.getElementById('video');
        const alignmentLine = document.getElementById('alignment-line');
        const startButton = document.getElementById('startButton');
        const flashButton = document.getElementById('flashButton');
        const captureButton = document.getElementById('captureButton');
        const croppedResult = document.getElementById('croppedResult');
        const decodedResult = document.getElementById('decodedResult');
        const statusText = document.getElementById('status');
        const cameraError = document.getElementById('camera-error');

        // State
        const state = {
            stream: null,
            track: null,
            flashOn: false,
            isScanning: false,
            scanCanvas: document.createElement('canvas'),
            scanContext: null
        };
        state.scanContext = state.scanCanvas.getContext('2d', { willReadFrequently: true });

        // Start camera with multiple fallbacks and initialize Quagga
        async function startCamera() {
            cameraError.style.display = 'none';
            statusText.textContent = "Starting camera...";
            startButton.disabled = true;

            try {
                // Try different camera constraints with fallbacks
                const constraintsAttempts = [
                    { // Ideal constraints
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    },
                    { // Basic constraints
                        video: {
                            facingMode: 'environment'
                        }
                    },
                    { // Fallback to any camera
                        video: true
                    }
                ];

                for (const constraints of constraintsAttempts) {
                    try {
                        state.stream = await navigator.mediaDevices.getUserMedia(constraints);
                        break; // Exit loop if successful
                    } catch (err) {
                        console.log(`Camera attempt failed: ${err.message}`);
                        if (constraints === constraintsAttempts[constraintsAttempts.length-1]) {
                            throw err; // Throw if last attempt failed
                        }
                    }
                }

                video.srcObject = state.stream;
                video.style.display = 'block';

                // Wait for video to be ready
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error("Camera timed out after 5 seconds"));
                    }, 5000);

                    video.onplaying = () => {
                        clearTimeout(timeout);
                        resolve();
                    };
                    video.onerror = reject;
                });

                // Get video track for flash control
                state.track = state.stream.getVideoTracks()[0];

                // Initialize alignment line
                alignmentLine.style.display = 'block';

                // Enable controls
                flashButton.disabled = false;
                captureButton.disabled = false;

                // Check flash support
                if (state.track.getCapabilities().torch) {
                    flashButton.disabled = false;
                } else {
                    flashButton.disabled = true;
                    flashButton.title = "Flash not supported on this device";
                }

                statusText.textContent = "Align barcode with green line";
                state.isScanning = true;
                initQuagga(); // Initialize Quagga after camera starts
                scanFrame();

            } catch (error) {
                handleCameraError(error);
            }
        }

        function initQuagga() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: video // Pass the video element as the stream target
                },
                decoder: {
                    readers: ["ean_8_reader", "ean_13_reader", "code_39_reader", "code_128_reader"] // Specify barcode types
                }
            }, function(err) {
                if (err) {
                    console.error("Quagga initialization failed:", err);
                    statusText.textContent = "Barcode reader initialization failed.";
                    return
                }
                console.log("Quagga initialization successful.");
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                console.log("Barcode detected:", result);
                if (result && result.codeResult && result.codeResult.code) {
                    decodedResult.textContent = `Decoded: ${result.codeResult.code}`;
                    decodedResult.style.display = 'block';
                    statusText.textContent = "Decoding successful!";
                    Quagga.stop(); // Stop scanning after successful decode (optional)
                    state.isScanning = false;
                    captureButton.disabled = true;
                }
            });
        }

        // Toggle flash with proper error handling
        async function toggleFlash() {
            if (!state.track || !state.track.getCapabilities().torch) {
                statusText.textContent = "Flash not supported on this device";
                return;
            }

            state.flashOn = !state.flashOn;
            try {
                await state.track.applyConstraints({
                    advanced: [{torch: state.flashOn}]
                });
                flashButton.textContent = state.flashOn ? "Turn Off Flash" : "Turn On Flash";
                flashButton.classList.toggle('flash-on', state.flashOn);
            } catch (error) {
                statusText.textContent = "Failed to toggle flash";
                console.error("Flash error:", error);
                state.flashOn = false;
            }
        }

        // Continuous frame scanning (no longer manually decoding)
        function scanFrame() {
            if (!state.isScanning) return;
            requestAnimationFrame(scanFrame);
        }

        // Capture and decode barcode (Quagga handles the decoding)
        async function captureAndDecode() {
            if (!state.isScanning) return;
            statusText.textContent = "Scanning for barcode...";
            captureButton.disabled = true;
            // Quagga.start() is already called in initQuagga,
            // and it continuously scans the video stream.
            // The result is handled in the Quagga.onDetected callback.
        }

        // Handle camera errors (same as before)
        function handleCameraError(error) {
            console.error("Camera error:", error);
            cameraError.innerHTML = `
                <p>Camera error: ${error.message}</p>
                <p><strong>Troubleshooting:</strong></p>
                <ol>
                    <li>Refresh the page and try again</li>
                    <li>Check browser permissions (camera icon in address bar)</li>
                    <li>Ensure no other app is using the camera</li>
                    <li>Try a different browser (Chrome recommended)</li>
                </ol>
            `;
            cameraError.style.display = 'block';
            statusText.textContent = "Camera failed to start";
            cleanup();
        }

        // Cleanup resources (modified for Quagga)
        function cleanup() {
            if (state.stream) {
                state.stream.getTracks().forEach(track => {
                    if (state.flashOn && track.getCapabilities().torch) {
                        track.applyConstraints({ advanced: [{torch: false}] })
                            .catch(e => console.error("Error turning off flash:", e));
                    }
                    track.stop();
                });
                state.stream = null;
                state.track = null;
            }
            state.isScanning = false;
            video.style.display = 'none';
            alignmentLine.style.display = 'none';
            flashButton.disabled = true;
            captureButton.disabled = true;
            startButton.disabled = false;
            flashButton.textContent = "Turn On Flash";
            flashButton.classList.remove('flash-on');
            state.flashOn = false;
            if (Quagga) {
                Quagga.stop();
            }
        }

        // Event listeners (same as before)
        startButton.addEventListener('click', startCamera);
        flashButton.addEventListener('click', toggleFlash);
        captureButton.addEventListener('click', captureAndDecode);

        window.addEventListener('beforeunload', cleanup);
    </script>
</body>
</html>
