<script>
  const video = document.getElementById("video");
  const overlay = document.getElementById("overlay");
  const overlayCtx = overlay.getContext("2d");
  let stream;
  let useTorch = false;

  async function initCamera() {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { exact: "environment" },
        width: { ideal: 1280 },
        height: { ideal: 720 },
        advanced: [{ torch: useTorch }]
      },
      audio: false
    });
    video.srcObject = stream;

    video.onloadedmetadata = () => {
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
    };
  }

  async function toggleFlashlight() {
    if (!stream) return;
    const track = stream.getVideoTracks()[0];
    const capabilities = track.getCapabilities();
    if (capabilities.torch) {
      useTorch = !useTorch;
      await track.applyConstraints({
        advanced: [{ torch: useTorch }]
      });
    }
  }

  overlay.addEventListener("click", (e) => {
    const rect = overlay.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) * (overlay.width / rect.width));
    const y = Math.floor((e.clientY - rect.top) * (overlay.height / rect.height));
    detectAndCropFromTap(x, y);
  });

  function detectAndCropFromTap(tapX, tapY) {
    const tempCanvas = document.createElement("canvas");
    const tempCtx = tempCanvas.getContext("2d");
    tempCanvas.width = video.videoWidth;
    tempCanvas.height = video.videoHeight;
    tempCtx.drawImage(video, 0, 0);

    const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
    const { data, width, height } = imageData;

    const grayscale = new Uint8ClampedArray(width * height);
    for (let i = 0; i < data.length; i += 4) {
      grayscale[i / 4] = (data[i] + data[i + 1] + data[i + 2]) / 3;
    }

    function contrastAt(x, y) {
      const i1 = y * width + x;
      const i2 = y * width + (x + 1);
      return Math.abs(grayscale[i1] - grayscale[i2]);
    }

    // Scan vertically to find the height of a vertical line starting at tap point
    const verticalThreshold = 30;
    let top = tapY, bottom = tapY;
    for (let y = tapY; y > 0; y--) {
      if (contrastAt(tapX, y) > verticalThreshold) top = y;
      else break;
    }
    for (let y = tapY; y < height - 1; y++) {
      if (contrastAt(tapX, y) > verticalThreshold) bottom = y;
      else break;
    }

    const lineHeight = bottom - top;
    if (lineHeight < 10) return alert("No vertical line found at tap point.");

    // Trace horizontally left and right from tapX, looking for vertical lines with similar height
    const maxSpacing = 5;
    const threshold = 30;
    let lines = [tapX];

    function hasVerticalLine(x) {
      let matchHeight = 0;
      let yStart = tapY - lineHeight / 2;
      let yEnd = tapY + lineHeight / 2;
      for (let y = yStart; y < yEnd && y < height - 1; y++) {
        if (contrastAt(x, y) > threshold) matchHeight++;
      }
      return matchHeight > lineHeight * 0.6;
    }

    // Scan left
    for (let x = tapX - 1, gap = 0; x > 0 && gap < maxSpacing; x--) {
      if (hasVerticalLine(x)) {
        lines.unshift(x);
        gap = 0;
      } else {
        gap++;
      }
    }
    // Scan right
    for (let x = tapX + 1, gap = 0; x < width && gap < maxSpacing; x++) {
      if (hasVerticalLine(x)) {
        lines.push(x);
        gap = 0;
      } else {
        gap++;
      }
    }

    if (lines.length < 2) return alert("Not enough vertical lines detected.");

    const firstX = lines[0];
    const lastX = lines[lines.length - 1];
    const cropWidth = lastX - firstX;
    const cropHeight = lineHeight;
    const cropY = top;

    const cropCanvas = document.createElement("canvas");
    cropCanvas.width = cropWidth;
    cropCanvas.height = cropHeight;
    const cropCtx = cropCanvas.getContext("2d");
    cropCtx.drawImage(video, firstX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

    const croppedImage = new Image();
    croppedImage.src = cropCanvas.toDataURL();
    const displayArea = document.getElementById("croppedArea");
    displayArea.innerHTML = "";
    displayArea.appendChild(croppedImage);

    decodeBarcode(cropCanvas);
  }

  function decodeBarcode(canvas) {
    const codeReader = new ZXing.BrowserBarcodeReader();
    codeReader.decodeFromCanvas(canvas).then(result => {
      document.getElementById("decodedResult").innerText = result.text;
    }).catch(err => {
      document.getElementById("decodedResult").innerText = "No barcode found.";
    });
  }

  initCamera();
</script>
