<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barcode Detection</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }
    canvas, video {
      width: 90%;
      max-width: 400px;
      margin-top: 10px;
    }
    .buttons {
      margin: 10px;
    }
    .buttons button {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
    }
    #croppedArea img {
      max-width: 90%;
      margin-top: 10px;
    }
  </style>
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
</head>
<body>
  <h2>Barcode Detection</h2>
  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
  <div class="buttons">
    <button onclick="toggleFlashlight()">Toggle Flashlight</button>
  </div>
  <h3>Cropped Area</h3>
  <div id="croppedArea"></div>
  <h3>Decoded Barcode</h3>
  <div id="decodedResult"></div>
  <script>
    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const overlayCtx = overlay.getContext("2d");
    let stream;
    let useTorch = false;

    async function initCamera() {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { exact: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 },
          advanced: [{ torch: useTorch }]
        },
        audio: false
      });
      video.srcObject = stream;

      video.onloadedmetadata = () => {
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
      };
    }

    async function toggleFlashlight() {
      if (!stream) return;
      const track = stream.getVideoTracks()[0];
      const capabilities = track.getCapabilities();
      if (capabilities.torch) {
        useTorch = !useTorch;
        await track.applyConstraints({
          advanced: [{ torch: useTorch }]
        });
      }
    }

    overlay.addEventListener("click", (e) => {
      const rect = overlay.getBoundingClientRect();
      const scaleX = video.videoWidth / rect.width;
      const scaleY = video.videoHeight / rect.height;
      const x = Math.floor((e.clientX - rect.left) * scaleX);
      const y = Math.floor((e.clientY - rect.top) * scaleY);
      detectBarcodeFromPoint(x, y);
    });

    function detectBarcodeFromPoint(startX, startY) {
      const tempCanvas = document.createElement("canvas");
      const tempCtx = tempCanvas.getContext("2d");
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      tempCtx.drawImage(video, 0, 0);

      const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const { data, width, height } = imageData;

      const grayscale = new Uint8ClampedArray(width * height);
      for (let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        grayscale[i / 4] = avg;
      }

      const threshold = 15; // intensity difference threshold
      const maxSpacing = 5; // max allowed spacing to consider connected
      const minLineLength = 20;

      let lines = [];
      for (let dx = -100; dx <= 100; dx++) {
        const x = startX + dx;
        if (x <= 0 || x >= width - 1) continue;
        let diffSum = 0;
        for (let y = 0; y < height - 1; y++) {
          const i1 = y * width + x;
          const i2 = (y + 1) * width + x;
          diffSum += Math.abs(grayscale[i1] - grayscale[i2]);
        }
        if (diffSum > threshold * height / 2) {
          lines.push(x);
        }
      }

      if (lines.length < 2) return alert("No barcode lines detected.");

      // Merge lines with spacing less than maxSpacing
      let grouped = [];
      let group = [lines[0]];
      for (let i = 1; i < lines.length; i++) {
        if (lines[i] - lines[i - 1] <= maxSpacing) {
          group.push(lines[i]);
        } else {
          if (group.length >= minLineLength) grouped.push([...group]);
          group = [lines[i]];
        }
      }
      if (group.length >= minLineLength) grouped.push([...group]);

      if (grouped.length === 0) return alert("No barcode area found.");

      const firstX = grouped[0][0];
      const lastX = grouped[grouped.length - 1].slice(-1)[0];
      const cropWidth = lastX - firstX;
      const cropHeight = 100;
      const cropY = Math.max(0, startY - cropHeight / 2);

      const cropCanvas = document.createElement("canvas");
      cropCanvas.width = cropWidth;
      cropCanvas.height = cropHeight;
      const cropCtx = cropCanvas.getContext("2d");
      cropCtx.drawImage(video, firstX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

      const croppedImage = new Image();
      croppedImage.src = cropCanvas.toDataURL();
      const displayArea = document.getElementById("croppedArea");
      displayArea.innerHTML = "";
      displayArea.appendChild(croppedImage);

      decodeBarcode(cropCanvas);
    }

    function decodeBarcode(canvas) {
      const codeReader = new ZXing.BrowserBarcodeReader();
      codeReader.decodeFromCanvas(canvas).then(result => {
        document.getElementById("decodedResult").innerText = result.text;
      }).catch(err => {
        document.getElementById("decodedResult").innerText = "No barcode found.";
      });
    }

    initCamera();
  </script>
</body>
</html>
