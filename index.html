<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precise Barcode Cropper</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }
        #scanner-container {
            position: relative;
            width: 100%;
            margin: 0 auto;
            max-width: 500px;
        }
        #video {
            width: 100%;
            background: #000;
            border: 2px solid #333;
        }
        #canvas {
            display: none;
        }
        button {
            padding: 12px 20px;
            margin: 10px 5px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #results {
            margin-top: 20px;
            text-align: center;
        }
        #croppedResult {
            max-width: 100%;
            border: 2px solid #4CAF50;
            margin-top: 15px;
        }
        #status {
            margin: 10px 0;
            font-weight: bold;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Precise Barcode Cropper</h1>
    
    <div id="scanner-container">
        <video id="video" playsinline autoplay></video>
        <canvas id="overlay"></canvas>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>
    
    <div style="text-align: center;">
        <button id="startButton">Start Camera</button>
        <button id="captureButton" disabled>Capture Barcode</button>
    </div>
    
    <div id="results">
        <div id="status">Status: Ready</div>
        <img id="croppedResult" style="display: none;">
    </div>

    <script>
        // DOM elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const overlay = document.getElementById('overlay');
        const overlayCtx = overlay.getContext('2d');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const captureButton = document.getElementById('captureButton');
        const croppedResult = document.getElementById('croppedResult');
        const statusText = document.getElementById('status');
        
        // Variables
        let stream = null;
        let scanInterval = null;
        let lastDetection = null;

        // Start camera
        startButton.addEventListener('click', async () => {
            try {
                statusText.textContent = "Starting camera...";
                
                // Stop any existing stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Get camera access
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                video.srcObject = stream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onplaying = resolve;
                });
                
                // Set canvas dimensions
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                overlay.width = video.videoWidth;
                overlay.height = video.videoHeight;
                
                startButton.disabled = true;
                captureButton.disabled = false;
                statusText.textContent = "Scanning... Point at barcode";
                
                // Start scanning for barcode frames
                scanInterval = setInterval(scanForBarcode, 200);
                
            } catch (error) {
                statusText.textContent = "Error: " + error.message;
                console.error("Camera error:", error);
            }
        });

        // Improved barcode frame detection
        function scanForBarcode() {
            // Draw current frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Convert to grayscale
            const grayData = new Uint8Array(imageData.width * imageData.height);
            for (let i = 0, j = 0; i < imageData.data.length; i += 4, j++) {
                grayData[j] = Math.round(0.299 * imageData.data[i] + 
                                        0.587 * imageData.data[i+1] + 
                                        0.114 * imageData.data[i+2]);
            }
            
            // Find vertical edges (common in barcodes)
            const edgeThreshold = 30;
            const edges = [];
            
            for (let y = 1; y < imageData.height - 1; y++) {
                for (let x = 1; x < imageData.width - 1; x++) {
                    const i = y * imageData.width + x;
                    // Vertical edge detection
                    const vertDiff = Math.abs(grayData[i - imageData.width] - grayData[i + imageData.width]);
                    if (vertDiff > edgeThreshold) {
                        edges.push({x, y});
                    }
                }
            }
            
            // Find bounding box if enough edges found
            if (edges.length > 100) {
                const xs = edges.map(p => p.x);
                const ys = edges.map(p => p.y);
                
                lastDetection = {
                    x: Math.min(...xs),
                    y: Math.min(...ys),
                    width: Math.max(...xs) - Math.min(...xs),
                    height: Math.max(...ys) - Math.min(...ys)
                };
                
                // Draw detection box on overlay
                overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
                overlayCtx.strokeStyle = '#00FF00';
                overlayCtx.lineWidth = 3;
                overlayCtx.strokeRect(
                    lastDetection.x, 
                    lastDetection.y, 
                    lastDetection.width, 
                    lastDetection.height
                );
                
                statusText.textContent = "Barcode detected!";
            } else {
                lastDetection = null;
                overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
                statusText.textContent = "Scanning... Point at barcode";
            }
        }

        // Capture and crop barcode area
        captureButton.addEventListener('click', () => {
            if (!lastDetection) {
                statusText.textContent = "No barcode detected!";
                return;
            }
            
            // Add 20% padding
            const padding = 0.2;
            const padX = lastDetection.width * padding;
            const padY = lastDetection.height * padding;
            
            const cropX = Math.max(0, lastDetection.x - padX);
            const cropY = Math.max(0, lastDetection.y - padY);
            const cropWidth = Math.min(canvas.width - cropX, lastDetection.width + 2 * padX);
            const cropHeight = Math.min(canvas.height - cropY, lastDetection.height + 2 * padY);
            
            // Create cropped image
            const croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = cropWidth;
            croppedCanvas.height = cropHeight;
            const croppedCtx = croppedCanvas.getContext('2d');
            
            // Perform the crop
            croppedCtx.drawImage(
                canvas, 
                cropX, cropY, cropWidth, cropHeight,
                0, 0, cropWidth, cropHeight
            );
            
            // Display result
            croppedResult.src = croppedCanvas.toDataURL('image/jpeg');
            croppedResult.style.display = 'block';
            statusText.textContent = `Cropped barcode: ${Math.round(cropWidth)}x${Math.round(cropHeight)}px`;
        });

        // Clean up
        window.addEventListener('beforeunload', () => {
            if (stream) stream.getTracks().forEach(track => track.stop());
            if (scanInterval) clearInterval(scanInterval);
        });
    </script>
</body>
</html>
