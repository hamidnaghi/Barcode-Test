function scanForBarcode() {
    try {
        // 1. Capture frame
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // 2. Pre-process image for better detection
        const grayData = convertToGrayscale(imageData.data);
        const thresholdData = applyThreshold(grayData, 120);
        
        // 3. Try multiple detection methods
        let code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "attemptBoth",
            canOverwriteImage: false
        });
        
        // 4. If no QR found, try looking for linear barcodes
        if (!code) {
            code = findLinearBarcode(thresholdData, imageData.width, imageData.height);
        }
        
        if (code) {
            barcodeLocation = code.location;
            drawBarcodeBox(code.location);
            statusText.textContent = `Found: ${code.format || 'Barcode'}`;
            debugLog(`Detected ${code.format || 'barcode'} at ${JSON.stringify(code.location)}`);
            return true;
        }
        
        return false;
        
    } catch (error) {
        debugLog(`Scan error: ${error.message}`);
        return false;
    }
}

// Helper functions
function convertToGrayscale(imageData) {
    const grayData = new Uint8ClampedArray(imageData.length/4);
    for (let i = 0, j = 0; i < imageData.length; i += 4, j++) {
        grayData[j] = Math.round(0.299 * imageData[i] + 0.587 * imageData[i+1] + 0.114 * imageData[i+2]);
    }
    return grayData;
}

function applyThreshold(imageData, threshold) {
    const thresholdData = new Uint8ClampedArray(imageData.length);
    for (let i = 0; i < imageData.length; i++) {
        thresholdData[i] = imageData[i] > threshold ? 255 : 0;
    }
    return thresholdData;
}

function findLinearBarcode(imageData, width, height) {
    // Simple vertical edge detection for demonstration
    // In production, use a library like ZXing for proper 1D barcode detection
    const edges = [];
    const threshold = 50;
    
    for (let y = 0; y < height; y++) {
        for (let x = 1; x < width; x++) {
            const diff = Math.abs(imageData[y*width + x] - imageData[y*width + x-1]);
            if (diff > threshold) edges.push({x, y});
        }
    }
    
    if (edges.length > width * 0.3) { // If many edges found
        return {
            format: "LINEAR",
            location: {
                topLeftCorner: { x: 0, y: 0 },
                topRightCorner: { x: width, y: 0 },
                bottomRightCorner: { x: width, y: height },
                bottomLeftCorner: { x: 0, y: height }
            }
        };
    }
    return null;
}
