<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Detect and Crop Rectangle</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    #video, #canvas, #croppedCanvas {
      max-width: 95vw;
      margin-top: 10px;
      border: 2px solid #000;
    }
  </style>
</head>
<body>
  <h2>Tap to Detect & Crop Rectangle</h2>
  <video id="video" autoplay playsinline></video><br>
  <canvas id="canvas"></canvas><br>
  <canvas id="croppedCanvas"></canvas>

  <!-- Make sure opencv.js is downloaded and in same folder -->
  <script src="opencv.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const croppedCanvas = document.getElementById('croppedCanvas');

    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
    }

    function getLargestRectContour(contours) {
      let maxArea = 0;
      let bestContour = null;
      for (let i = 0; i < contours.size(); i++) {
        const cnt = contours.get(i);
        const approx = new cv.Mat();
        cv.approxPolyDP(cnt, approx, 0.02 * cv.arcLength(cnt, true), true);
        if (approx.rows === 4 && cv.isContourConvex(approx)) {
          const area = cv.contourArea(approx);
          if (area > maxArea) {
            maxArea = area;
            bestContour = approx.clone();
          }
        }
        approx.delete();
      }
      return bestContour;
    }

    function cropFromContour(src, contour) {
      const pts = [];
      for (let i = 0; i < 4; i++) {
        pts.push({ x: contour.intPtr(i, 0)[0], y: contour.intPtr(i, 0)[1] });
      }

      // Sort points (top-left, top-right, bottom-right, bottom-left)
      pts.sort((a, b) => a.y - b.y);
      const [tl, tr] = pts.slice(0, 2).sort((a, b) => a.x - b.x);
      const [bl, br] = pts.slice(2).sort((a, b) => a.x - b.x);

      const srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
        tl.x, tl.y, tr.x, tr.y, br.x, br.y, bl.x, bl.y
      ]);
      const width = Math.max(
        Math.hypot(tr.x - tl.x, tr.y - tl.y),
        Math.hypot(br.x - bl.x, br.y - bl.y)
      );
      const height = Math.max(
        Math.hypot(bl.x - tl.x, bl.y - tl.y),
        Math.hypot(br.x - tr.x, br.y - tr.y)
      );

      const dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
        0, 0, width, 0, width, height, 0, height
      ]);

      const M = cv.getPerspectiveTransform(srcTri, dstTri);
      const dst = new cv.Mat();
      cv.warpPerspective(src, dst, M, new cv.Size(width, height));

      srcTri.delete(); dstTri.delete(); M.delete();
      return dst;
    }

    function processFrame() {
      const width = video.videoWidth;
      const height = video.videoHeight;
      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, width, height);

      let src = cv.imread(canvas);
      let gray = new cv.Mat();
      let blurred = new cv.Mat();
      let edged = new cv.Mat();
      let contours = new cv.MatVector();
      let hierarchy = new cv.Mat();

      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
      cv.Canny(blurred, edged, 75, 200);
      cv.findContours(edged, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      const bestContour = getLargestRectContour(contours);
      if (bestContour) {
        const color = new cv.Scalar(0, 255, 0, 255); // Green
        const contoursDraw = new cv.MatVector();
        contoursDraw.push_back(bestContour);
        cv.drawContours(src, contoursDraw, -1, color, 3);

        const cropped = cropFromContour(src, bestContour);
        cv.imshow(croppedCanvas, cropped);
        cropped.delete();
        contoursDraw.delete();
        bestContour.delete();
      } else {
        alert("No rectangular contour found.");
      }

      cv.imshow(canvas, src);

      // Cleanup
      src.delete(); gray.delete(); blurred.delete(); edged.delete();
      contours.delete(); hierarchy.delete();
    }

    document.addEventListener('DOMContentLoaded', () => {
      startCamera();
      video.addEventListener('click', processFrame);
    });
  </script>
</body>
</html>
