<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Symbol OCR Matcher</title>
  <style>
    /* [Keep your existing CSS styles] */
  </style>
</head>
<body>
  <!-- [Keep your existing HTML structure] -->

  <script>
    // Configuration
    const NUM_SYMBOLS = 16;
    const MATCH_THRESHOLD = 0.8; // Similarity threshold (0-1)
    
    // State
    let referenceTemplates = [];
    let cvReady = false;
    
    // Load OpenCV.js
    const script = document.createElement('script');
    script.src = 'https://docs.opencv.org/4.5.5/opencv.js';
    script.onload = initApp;
    document.head.appendChild(script);

    function initApp() {
      cv.onRuntimeInitialized = () => {
        cvReady = true;
        updateStatus("OpenCV.js ready - loading reference templates...");
        loadReferenceTemplates();
      };
    }

    function loadReferenceTemplates() {
      const container = document.getElementById('referenceSymbols');
      container.innerHTML = '';
      
      for (let i = 0; i < NUM_SYMBOLS; i++) {
        const div = document.createElement('div');
        div.className = 'symbol';
        div.innerHTML = `<div>Symbol ID: ${i}</div>`;
        container.appendChild(div);
        
        // Create template
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = 100;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        const svg = document.getElementById(`symbol${i}`);
        const svgData = new XMLSerializer().serializeToString(svg);
        const img = new Image();
        
        img.onload = function() {
          ctx.drawImage(img, 0, 0, 100, 100);
          const src = cv.imread(canvas);
          const gray = new cv.Mat();
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
          referenceTemplates[i] = gray;
          div.prepend(canvas);
        };
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
      }
      
      updateStatus("Ready to match symbols!");
      document.getElementById('fileInput').disabled = false;
      document.getElementById('processBtn').disabled = false;
    }

    function matchSymbols() {
      document.getElementById('results').innerHTML = `
        <div class="processing">
          <div class="spinner"></div>
          <p>Processing image...</p>
        </div>
      `;
      
      setTimeout(() => {
        try {
          const inputCanvas = document.getElementById('inputCanvas');
          if (!inputCanvas || inputCanvas.width === 0) {
            throw new Error("Please load an image first");
          }
          
          // Process input image
          const src = cv.imread('inputCanvas');
          const gray = new cv.Mat();
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
          
          // Resize input to match template size (100x100)
          const resized = new cv.Mat();
          cv.resize(gray, resized, new cv.Size(100, 100));
          
          // Match against all templates
          const matches = [];
          for (let i = 0; i < NUM_SYMBOLS; i++) {
            if (!referenceTemplates[i]) continue;
            
            // Calculate similarity
            const diff = new cv.Mat();
            cv.absdiff(resized, referenceTemplates[i], diff);
            
            // Count non-zero pixels (differences)
            const count = cv.countNonZero(diff);
            const totalPixels = 100 * 100;
            const similarity = 1 - (count / totalPixels);
            
            if (similarity >= MATCH_THRESHOLD) {
              matches.push({
                symbolId: i,
                confidence: Math.round(similarity * 100),
                diffCount: count
              });
            }
            
            diff.delete();
          }
          
          // Display results
          let resultsHTML = '';
          if (matches.length > 0) {
            matches.sort((a, b) => b.confidence - a.confidence);
            resultsHTML = '<h3>Matched Symbols:</h3>';
            
            matches.slice(0, 3).forEach(match => {
              const svg = document.getElementById(`symbol${match.symbolId}`).cloneNode(true);
              svg.style.width = '60px';
              svg.style.height = '60px';
              
              resultsHTML += `
                <div class="match-result">
                  <div class="symbol-preview">${svg.outerHTML}</div>
                  <div class="match-details">
                    <p><strong>Symbol ID:</strong> ${match.symbolId}</p>
                    <p><strong>Confidence:</strong> ${match.confidence}%</p>
                    <p><strong>Pixel differences:</strong> ${match.diffCount}</p>
                  </div>
                </div>
              `;
            });
          } else {
            resultsHTML = `
              <div class="no-matches">
                <h3>No Matches Found</h3>
                <p>No symbols matched with sufficient confidence.</p>
                <p>Try adjusting the image quality or symbol size.</p>
              </div>
            `;
          }
          
          document.getElementById('results').innerHTML = resultsHTML;
          
          // Cleanup
          src.delete();
          gray.delete();
          resized.delete();
        } catch (err) {
          document.getElementById('results').innerHTML = `
            <div class="debug-error">
              <h4>Error: ${err.message}</h4>
              <p>Check console for details</p>
            </div>
          `;
          console.error(err);
        }
      }, 100);
    }

    function testWithSampleImage() {
      const canvas = document.getElementById('inputCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 200;
      canvas.height = 200;
      
      // Pure black square test
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'black';
      ctx.fillRect(50, 50, 100, 100); // Centered square
      
      updateStatus("Black square test image loaded");
      document.getElementById('results').innerHTML = "Ready to match test image...";
    }

    // [Keep your existing event listeners and helper functions]
  </script>
</body>
</html>