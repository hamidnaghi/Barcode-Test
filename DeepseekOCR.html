<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Symbol Matcher - Ver1 </title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #referenceSymbols {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .symbol {
      text-align: center;
      padding: 10px;
      border: 1px solid #ddd;
    }
    canvas {
      max-width: 100%;
      border: 1px solid #ccc;
      margin: 10px 0;
    }
    #status {
      padding: 10px;
      margin: 10px 0;
      background: #e3f2fd;
    }
    button {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:disabled {
      opacity: 0.5;
    }
    #results {
      margin-top: 20px;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 5px;
    }
    .match {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background: white;
      border-radius: 4px;
    }
    .match svg {
      width: 50px;
      height: 50px;
      margin-right: 15px;
    }
    .processing {
      text-align: center;
      padding: 20px;
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Symbol Matcher</h1>
  
  <div id="status">Loading OpenCV.js...</div>
  
  <div id="referenceSymbols"></div>
  
  <input type="file" id="fileInput" accept="image/*" disabled>
  <button id="processBtn" disabled>Match Symbols</button>
  <button id="testBtn">Test with Black Square</button>
  
  <div>
    <canvas id="inputCanvas"></canvas>
    <canvas id="debugCanvas"></canvas>
  </div>
  
  <div id="results">Waiting for initialization...</div>

  <!-- Reference SVGs -->
  <div id="svgTemplates" style="display: none;">
    <!-- [Keep all your SVG definitions from earlier] -->
  </div>

  <script>
    // Configuration
    const NUM_SYMBOLS = 16;
    const MATCH_THRESHOLD = 0.85; // Similarity threshold
    
    // State
    let referenceTemplates = [];
    let cvReady = false;
    
    // Load OpenCV.js
    const script = document.createElement('script');
    script.src = 'https://docs.opencv.org/4.5.5/opencv.js';
    script.onload = initApp;
    script.onerror = () => updateStatus("Failed to load OpenCV.js", true);
    document.head.appendChild(script);

    function initApp() {
      cv.onRuntimeInitialized = () => {
        cvReady = true;
        updateStatus("OpenCV.js ready - loading reference symbols...");
        loadReferenceSymbols();
      };
    }

    function loadReferenceSymbols() {
      const container = document.getElementById('referenceSymbols');
      container.innerHTML = '';
      
      for (let i = 0; i < NUM_SYMBOLS; i++) {
        const div = document.createElement('div');
        div.className = 'symbol';
        div.innerHTML = `<div>ID: ${i}</div>`;
        container.appendChild(div);
        
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = 100;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        const svg = document.getElementById(`symbol${i}`);
        if (!svg) {
          console.error(`Symbol ${i} not found`);
          continue;
        }
        
        const svgData = new XMLSerializer().serializeToString(svg);
        const img = new Image();
        
        img.onload = function() {
          ctx.drawImage(img, 0, 0, 100, 100);
          
          // Create template
          const src = cv.imread(canvas);
          const gray = new cv.Mat();
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
          referenceTemplates[i] = gray;
          
          // Show in reference panel
          div.prepend(canvas);
          
          // Cleanup
          src.delete();
        };
        
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
      }
      
      updateStatus("Ready to match symbols!");
      document.getElementById('fileInput').disabled = false;
      document.getElementById('processBtn').disabled = false;
      document.getElementById('testBtn').disabled = false;
    }

    function matchSymbols() {
      if (!cvReady) {
        updateStatus("OpenCV not ready yet", true);
        return;
      }
      
      const canvas = document.getElementById('inputCanvas');
      if (!canvas || canvas.width === 0) {
        updateStatus("Please load an image first", true);
        return;
      }
      
      document.getElementById('results').innerHTML = `
        <div class="processing">
          <div class="spinner"></div>
          <p>Processing image...</p>
        </div>
      `;
      
      setTimeout(() => {
        try {
          // Process input image
          const src = cv.imread('inputCanvas');
          const gray = new cv.Mat();
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
          
          // Resize to match template size
          const resized = new cv.Mat();
          cv.resize(gray, resized, new cv.Size(100, 100));
          
          // Show processed image
          cv.imshow('debugCanvas', resized);
          
          // Match against templates
          const matches = [];
          for (let i = 0; i < NUM_SYMBOLS; i++) {
            if (!referenceTemplates[i]) continue;
            
            // Calculate absolute difference
            const diff = new cv.Mat();
            cv.absdiff(resized, referenceTemplates[i], diff);
            
            // Convert to binary (black/white)
            const thresholded = new cv.Mat();
            cv.threshold(diff, thresholded, 30, 255, cv.THRESH_BINARY);
            
            // Count different pixels
            const differentPixels = cv.countNonZero(thresholded);
            const similarity = 1 - (differentPixels / (100 * 100));
            
            if (similarity >= MATCH_THRESHOLD) {
              matches.push({
                symbolId: i,
                confidence: Math.round(similarity * 100),
                diff: differentPixels
              });
            }
            
            diff.delete();
            thresholded.delete();
          }
          
          // Display results
          if (matches.length > 0) {
            matches.sort((a, b) => b.confidence - a.confidence);
            let resultsHTML = '<h3>Matched Symbols:</h3>';
            
            matches.slice(0, 3).forEach(match => {
              const svg = document.getElementById(`symbol${match.symbolId}`).cloneNode(true);
              svg.style.width = '50px';
              svg.style.height = '50px';
              
              resultsHTML += `
                <div class="match">
                  ${svg.outerHTML}
                  <div>
                    <strong>Symbol ID:</strong> ${match.symbolId}<br>
                    <strong>Confidence:</strong> ${match.confidence}%<br>
                    <strong>Different Pixels:</strong> ${match.diff}
                  </div>
                </div>
              `;
            });
            
            document.getElementById('results').innerHTML = resultsHTML;
            updateStatus(`Found ${matches.length} matches! Best match: ID ${matches[0].symbolId} (${matches[0].confidence}%)`);
          } else {
            document.getElementById('results').innerHTML = `
              <div style="padding: 20px; background: #ffebee; border-radius: 5px;">
                <h3>No Matches Found</h3>
                <p>No symbols matched with sufficient confidence.</p>
                <p>Try:</p>
                <ul>
                  <li>Clearer images with better contrast</li>
                  <li>Larger symbols in the image</li>
                  <li>Adjusting the camera angle</li>
                </ul>
              </div>
            `;
            updateStatus("No matches found", true);
          }
          
          // Cleanup
          src.delete();
          gray.delete();
          resized.delete();
        } catch (err) {
          console.error("Matching error:", err);
          document.getElementById('results').innerHTML = `
            <div style="padding: 20px; background: #ffebee; border-radius: 5px; color: #d32f2f;">
              <h3>Error Processing Image</h3>
              <p>${err.message}</p>
              <p>Check console for details</p>
            </div>
          `;
          updateStatus("Error during processing", true);
        }
      }, 100);
    }

    function testWithBlackSquare() {
      const canvas = document.getElementById('inputCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 200;
      canvas.height = 200;
      
      // Clear canvas
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw black square
      ctx.fillStyle = 'black';
      ctx.fillRect(50, 50, 100, 100); // Centered 100x100 square
      
      updateStatus("Black square test image loaded");
      document.getElementById('results').innerHTML = "Click 'Match Symbols' to test";
    }

    function updateStatus(message, isError = false) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.style.background = isError ? '#ffebee' : '#e3f2fd';
      statusDiv.style.color = isError ? '#d32f2f' : 'inherit';
      console.log(message);
    }

    // Event listeners
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.getElementById('inputCanvas');
          const ctx = canvas.getContext('2d');
          
          // Resize if too large
          const maxSize = 800;
          let width = img.width;
          let height = img.height;
          
          if (width > maxSize || height > maxSize) {
            const ratio = Math.min(maxSize/width, maxSize/height);
            width = Math.floor(width * ratio);
            height = Math.floor(height * ratio);
          }
          
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          updateStatus("Image loaded. Click 'Match Symbols'");
        };
        img.onerror = () => updateStatus("Failed to load image", true);
        img.src = event.target.result;
      };
      reader.onerror = () => updateStatus("Failed to read file", true);
      reader.readAsDataURL(file);
    });

    document.getElementById('processBtn').addEventListener('click', matchSymbols);
    document.getElementById('testBtn').addEventListener('click', testWithBlackSquare);
  </script>
</body>
</html>
