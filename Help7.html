<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Media Sequence Viewer with Pointer</title>
    <style>
        /* [Keep all your existing CSS styles] */
    </style>
</head>
<body>
    <!-- [Keep all your existing HTML structure] -->

    <script>
        // Configuration - EDIT THESE TO MATCH YOUR FILES
        const mediaFiles = [
            { 
                media: "pic1.jpg", 
                audio: "sound1.mp3", 
                caption: "برای اینکه مکالمه را از صحبت منفی در مورد کسی که در آن صحنه حضور ندارد دور کنید، می توانید به آرامی مکالمه را تغییر دهید و در مورد آن شخص غایب موارد مثبتی مطرح کنید, بدین ترتیب لحن محترمانه ای در گفتگو ادامه پیدا خواهد کرد.",
                pointerPath: [
                    { x: 20, y: 20, wait: 10000 },
                    { x: 80, y: 30, wait: 15000 },
                    { x: 50, y: 70, wait: 20000 }
                ]
            },
            { 
                media: "pic2.jpg", 
                audio: "sound2.mp3", 
                caption: "نپرسید کشورتان برای شما چه کرده است، بلکه بپرسید شما برای کشورتان چه کرده‌اید - جان اف کندی",
                pointerPath: [
                    { x: 10, y: 10, wait: 8000 },
                    { x: 90, y: 20, wait: 12000 },
                    { x: 40, y: 60, wait: 25000 }
                ]
            },
            { 
                media: "hamid.gif", 
                audio: "sound3.mp3", 
                caption: "آن که پل‌های پشت سرش را به فراموشی می‌سپارد، دیر یا زود درمی‌یابد که راه پیش رو، بدون دست یاری دیگران، دشوارتر از آن است که می‌پنداشت.",
                pointerPath: [
                    { x: 30, y: 40, wait: 15000 },
                    { x: 70, y: 50, wait: 18000 },
                    { x: 20, y: 80, wait: 12000 }
                ]
            }
        ];
        
        // State management
        const state = {
            currentIndex: 0,
            isPlaying: false,
            currentTransition: 'fade',
            timers: {
                progress: null,
                countdown: null,
                transition: null,
                pointer: null
            },
            currentPointerPath: []
        };
        
        // DOM elements cache
        const elements = {
            currentMedia: document.getElementById('currentMedia'),
            nextMedia: document.getElementById('nextMedia'),
            currentCaption: document.getElementById('currentCaption'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            playPauseBtn: document.getElementById('playPauseBtn'),
            playPauseText: document.getElementById('playPauseText'),
            playIcon: document.getElementById('playIcon'),
            pauseIcon: document.getElementById('pauseIcon'),
            progressBar: document.getElementById('progressBar'),
            currentAudio: document.getElementById('currentAudio'),
            countdown: document.getElementById('countdown'),
            currentSlide: document.getElementById('currentSlide'),
            totalSlides: document.getElementById('totalSlides'),
            pointer: document.getElementById('pointer'),
            pointerPathBody: document.getElementById('pointerPathBody'),
            errorMessage: document.getElementById('errorMessage')
        };

        // Initialize the application
        function init() {
            setupEventListeners();
            updateUI();
            loadCurrentSlide();
        }

        function loadCurrentSlide() {
            const file = mediaFiles[state.currentIndex];
            
            // Clear any previous errors
            showError(false);
            
            // Set current pointer path
            state.currentPointerPath = file.pointerPath || [];
            updatePointerPathTable(state.currentPointerPath);
            
            // Load media
            elements.currentMedia.src = file.media;
            elements.currentMedia.onerror = () => {
                showError(true, `Failed to load image: ${file.media}`);
            };
            
            // Load audio
            elements.currentAudio.src = file.audio;
            elements.currentAudio.onerror = () => {
                showError(true, `Failed to load audio: ${file.audio}`);
            };
            
            // Update caption
            elements.currentCaption.textContent = file.caption;
            
            // Update UI
            updateUI();
            
            // If playing, start the sequence
            if (state.isPlaying) {
                startAutoPlay();
            }
        }

        function startAutoPlay() {
            clearTimers();
            
            const file = mediaFiles[state.currentIndex];
            const duration = file.pointerPath.reduce((sum, p) => sum + p.wait, 0) || 5000;
            
            // Update countdown
            let secondsRemaining = Math.floor(duration / 1000);
            updateCountdown(secondsRemaining);
            
            // Countdown timer
            state.timers.countdown = setInterval(() => {
                secondsRemaining--;
                updateCountdown(secondsRemaining);
            }, 1000);
            
            // Progress bar animation
            let progress = 0;
            const increment = 100 / (duration / 100);
            
            state.timers.progress = setInterval(() => {
                progress += increment;
                elements.progressBar.style.width = Math.min(progress, 100) + '%';
            }, 100);
            
            // Start pointer animation
            movePointerAlongPath();
            
            // Set timer for next slide
            state.timers.transition = setTimeout(() => {
                if (state.currentIndex < mediaFiles.length - 1) {
                    state.currentIndex++;
                } else {
                    state.currentIndex = 0; // Loop to start
                }
                loadCurrentSlide();
            }, duration);
            
            // Play audio if available
            elements.currentAudio.play().catch(e => {
                console.log("Autoplay prevented:", e);
            });
        }

        function movePointerAlongPath() {
            clearTimeout(state.timers.pointer);
            
            const path = state.currentPointerPath;
            if (!path || path.length === 0) {
                elements.pointer.style.display = 'none';
                return;
            }
            
            let currentPointIndex = 0;
            elements.pointer.style.display = 'block';
            
            function moveToNextPoint() {
                if (currentPointIndex >= path.length) {
                    elements.pointer.style.display = 'none';
                    return;
                }
                
                const point = path[currentPointIndex];
                const mediaRect = elements.currentMedia.getBoundingClientRect();
                const containerRect = elements.currentMedia.parentElement.getBoundingClientRect();
                
                // Calculate positions
                const xPos = (point.x / 100) * mediaRect.width;
                const yPos = (point.y / 100) * mediaRect.height;
                const pointerX = containerRect.left + xPos;
                const pointerY = containerRect.top + yPos;
                
                // Apply smooth transition
                elements.pointer.style.left = `${pointerX}px`;
                elements.pointer.style.top = `${pointerY}px`;
                
                currentPointIndex++;
                
                if (currentPointIndex < path.length) {
                    state.timers.pointer = setTimeout(moveToNextPoint, 3000 + path[currentPointIndex].wait);
                }
            }
            
            // Initialize first position immediately without animation
            const firstPoint = path[0];
            const mediaRect = elements.currentMedia.getBoundingClientRect();
            const containerRect = elements.currentMedia.parentElement.getBoundingClientRect();
            const firstXPos = (firstPoint.x / 100) * mediaRect.width;
            const firstYPos = (firstPoint.y / 100) * mediaRect.height;
            const firstPointerX = containerRect.left + firstXPos;
            const firstPointerY = containerRect.top + firstYPos;
            
            elements.pointer.style.transition = 'none';
            elements.pointer.style.left = `${firstPointerX}px`;
            elements.pointer.style.top = `${firstPointerY}px`;
            
            // Force reflow
            void elements.pointer.offsetWidth;
            
            // Enable transition for subsequent movements
            elements.pointer.style.transition = 'left 3s ease-in-out, top 3s ease-in-out';
            
            // Start moving to next points
            state.timers.pointer = setTimeout(() => {
                moveToNextPoint();
            }, firstPoint.wait);
        }

        function updateUI() {
            elements.currentSlide.textContent = state.currentIndex + 1;
            elements.totalSlides.textContent = mediaFiles.length;
            elements.prevBtn.disabled = state.currentIndex === 0;
            elements.nextBtn.disabled = state.currentIndex === mediaFiles.length - 1;
            
            // Update play/pause button
            if (state.isPlaying) {
                elements.playIcon.style.display = 'none';
                elements.pauseIcon.style.display = 'block';
                elements.playPauseText.textContent = 'Pause';
            } else {
                elements.playIcon.style.display = 'block';
                elements.pauseIcon.style.display = 'none';
                elements.playPauseText.textContent = 'Play';
            }
        }

        function updatePointerPathTable(path) {
            elements.pointerPathBody.innerHTML = '';
            
            path.forEach((point, index) => {
                const row = document.createElement('tr');
                
                const pointCell = document.createElement('td');
                pointCell.textContent = index + 1;
                
                const xCell = document.createElement('td');
                xCell.textContent = `${point.x}%`;
                
                const yCell = document.createElement('td');
                yCell.textContent = `${point.y}%`;
                
                const waitCell = document.createElement('td');
                waitCell.textContent = point.wait;
                
                row.appendChild(pointCell);
                row.appendChild(xCell);
                row.appendChild(yCell);
                row.appendChild(waitCell);
                
                elements.pointerPathBody.appendChild(row);
            });
        }

        function updateCountdown(seconds) {
            elements.countdown.textContent = Math.max(0, seconds);
        }

        function showError(show, message = "") {
            elements.errorMessage.style.display = show ? 'block' : 'none';
            if (show) elements.errorMessage.textContent = message;
        }

        function clearTimers() {
            Object.values(state.timers).forEach(timer => {
                if (timer) clearTimeout(timer);
            });
            
            state.timers = {
                progress: null,
                countdown: null,
                transition: null,
                pointer: null
            };
            
            updateCountdown(0);
            elements.pointer.style.display = 'none';
        }

        function togglePlayPause() {
            state.isPlaying = !state.isPlaying;
            
            if (state.isPlaying) {
                startAutoPlay();
            } else {
                clearTimers();
                elements.currentAudio.pause();
            }
            
            updateUI();
        }

        function setupEventListeners() {
            // Navigation buttons
            elements.prevBtn.addEventListener('click', () => {
                if (state.currentIndex > 0) {
                    state.currentIndex--;
                    loadCurrentSlide();
                }
            });
            
            elements.nextBtn.addEventListener('click', () => {
                if (state.currentIndex < mediaFiles.length - 1) {
                    state.currentIndex++;
                    loadCurrentSlide();
                }
            });
            
            // Play/pause toggle
            elements.playPauseBtn.addEventListener('click', togglePlayPause);
            
            // Audio ended handler
            elements.currentAudio.addEventListener('ended', () => {
                if (state.isPlaying) {
                    if (state.currentIndex < mediaFiles.length - 1) {
                        state.currentIndex++;
                    } else {
                        state.currentIndex = 0;
                    }
                    loadCurrentSlide();
                }
            });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
