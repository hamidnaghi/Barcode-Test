<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner with Camera Controls</title>
    <style>
        /* Your existing CSS styles */
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        #interactive.viewport {
            position: relative;
            height: 40vh;
            overflow: hidden;
            text-align: center;
            background-color: #000;
        }
        #interactive.viewport > canvas, #interactive.viewport > video {
            height: 40vh;
            width: auto;
            max-width: 100vw;
            display: block;
            margin-left: auto;
            margin-right: auto;
            object-fit: contain;
        }
        /* Rest of your CSS styles */
    </style>
</head>
<body>
    <h1>Barcode Scanner</h1>
    
    <div>
        <button id="start-button" class="button">Start Camera</button>
        <button id="stop-button" class="button" disabled>Stop Camera</button>
        <button id="flash-button" class="button" disabled>Toggle Flash</button>
    </div>
    
    <div id="status">Click "Start Camera" to begin scanning</div>
    
    <div id="interactive" class="viewport">
        <!-- Camera feed will appear here -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const startButton = document.getElementById('start-button');
            const stopButton = document.getElementById('stop-button');
            const flashButton = document.getElementById('flash-button');
            const statusElement = document.getElementById('status');
            const interactiveViewport = document.getElementById('interactive');
            
            let stream = null;
            let isScanning = false;

            // Modified start camera function with better error handling
            startButton.addEventListener('click', async () => {
                if (isScanning) return;
                
                try {
                    statusElement.textContent = "Initializing camera...";
                    
                    // First get camera access
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: "environment",
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    // Create video element to show camera feed
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.setAttribute('playsinline', '');
                    interactiveViewport.appendChild(video);
                    video.play();
                    
                    // Initialize Quagga after camera is running
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: interactiveViewport,
                            constraints: {
                                facingMode: "environment"
                            }
                        },
                        locator: {
                            patchSize: "large",
                            halfSample: false
                        },
                        numOfWorkers: navigator.hardwareConcurrency || 4,
                        decoder: {
                            readers: ["code_128_reader", "ean_reader", "ean_8_reader", "upc_reader"]
                        },
                        locate: true
                    }, function(err) {
                        if (err) {
                            console.error("Quagga init error:", err);
                            statusElement.textContent = "Scanner initialization failed";
                            if (stream) stream.getTracks().forEach(track => track.stop());
                            return;
                        }
                        
                        Quagga.start();
                        isScanning = true;
                        
                        // Update UI
                        startButton.disabled = true;
                        stopButton.disabled = false;
                        flashButton.disabled = false;
                        statusElement.textContent = "Camera active. Point at a barcode.";
                        
                        // Setup detection callback
                        Quagga.onDetected(result => {
                            if (result && result.codeResult) {
                                statusElement.textContent = `Detected: ${result.codeResult.code}`;
                            }
                        });
                    });
                    
                } catch (error) {
                    console.error("Camera error:", error);
                    statusElement.textContent = `Error: ${error.message}`;
                    if (stream) stream.getTracks().forEach(track => track.stop());
                }
            });

            // Stop camera function
            stopButton.addEventListener('click', () => {
                if (!isScanning) return;
                
                Quagga.stop();
                isScanning = false;
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                // Clear video element
                interactiveViewport.innerHTML = '';
                
                // Update UI
                startButton.disabled = false;
                stopButton.disabled = true;
                flashButton.disabled = true;
                statusElement.textContent = "Scanner stopped";
            });

            // Flashlight control
            flashButton.addEventListener('click', async () => {
                if (!stream) return;
                
                const track = stream.getVideoTracks()[0];
                if (!track) return;
                
                try {
                    await track.applyConstraints({
                        advanced: [{torch: !track.getSettings().torch}]
                    });
                    flashButton.textContent = track.getSettings().torch ? 'Flash ON' : 'Flash OFF';
                } catch (err) {
                    console.error("Flash error:", err);
                    statusElement.textContent = "Flash not supported on this device";
                }
            });
        });
    </script>
</body>
</html>
